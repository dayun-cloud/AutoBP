<!doctype html>
<html lang="zh-CN">
<head>
  <link rel="icon" href="https://img.dayun.cool/_dayun/AutoBP.webp">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoBP - 英雄联盟自动BP助手</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans SC", "Microsoft YaHei", sans-serif; margin: 0; padding: 0; background: #1a1d23; color: #e7e9ee; min-height: 100vh; }
    
    header { padding: 12px 8px 8px 8px; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0)); border-bottom: 1px solid rgba(255,255,255,0.08); --wails-draggable: drag; user-select: none; }
    .header-inner { width: 390px; margin: 0; padding: 0px 0px 0px 15px; display: flex; align-items: center; justify-content: space-between; --wails-draggable: drag; position: relative; }
    .header-left { display: flex; align-items: center; gap: 50px; --wails-draggable: drag; }
    .header-controls { display: flex; height: 30px; --wails-draggable: none; position: absolute; right: 0; top: 0; }
    .header-button { width: 35px; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; --wails-draggable: none; border-radius: 4px; }
    .header-button:hover { background: rgba(255, 255, 255, 0.1); }
    .header-button.close:hover { background: #e81123; }
    .header-icon { width: 14px; height: 14px; fill: #e7e9ee; opacity: 0.8; stroke-width: 2; }
    h1 { font-size: 14px; margin: 0; letter-spacing: .3px; }
    h1 img { height: 52px !important; transform: scale(1.6); transform-origin: left center; }
    .status { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; max-width: 220px; margin: 0; }
    .badge { padding: 2px 5px; border-radius: 4px; font-size: 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); transition: all 0.2s ease; }
    .badge.connected { background: rgb(106, 167, 188); border-color: rgb(106, 167, 188); }
    .badge.error { background: rgb(220, 38, 127); border-color: rgb(220, 38, 127); }
    .refresh-btn { width: 20px; height: 20px; background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; --wails-draggable: none; font-size: 16px; }
    .refresh-btn:hover { opacity: 0.7; }
    .refresh-btn svg { width: 12px; height: 12px; fill: #e7e9ee; opacity: 0.8; }
    .refresh-btn:hover svg { opacity: 1; }

    /* 居中主区域 */
    main { padding: 10px 0px 0px 22px; max-width: 100%; margin: 0; display: grid; gap: 10px; }
    section { background: #242830; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 15px; margin: 0; width: 345px; min-height: 180px; }
    .section-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #fff; }

    /* 行：标题 | 下拉 | 开关 */
    .row { display: grid; grid-template-columns: 70px 150px 70px; align-items: center; gap: 25px; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.08); max-width: 100%; }
    .row:last-child { border-bottom: 0; }
    .row > div:first-child { overflow: hidden; }
    .row strong { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 130px; }
    .switch { position: relative; width: 42px; height: 24px; background: rgba(255,255,255,0.2); border-radius: 999px; cursor: pointer; border: 1px solid rgba(255,255,255,0.12); transition: .2s ease; justify-self: end; }
    .switch.on { background: rgb(106, 167, 188); }
    .knob { position: absolute; top: 1px; left: 1px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: .2s ease; }
    .switch.on .knob { transform: translateX(18px); }

    .muted { opacity: .8; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }

    /* 自定义下拉组件，内置搜索框 */
    .dropdown { position: relative; width: 160px; max-width: 100%; }
    .dropdown-trigger { width: 100%; padding: 7px 9px; background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.18); border-radius: 6px; outline: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 4px; font-size: 12px; }
    .dropdown-trigger .label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
    .dropdown-trigger .arrow { opacity: .8; transition: transform 0.2s ease; font-size: 10px; }
    .dropdown.open .dropdown-trigger .arrow { transform: rotate(180deg); }

    .dropdown-panel { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: rgb(33, 35, 39); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); padding: 6px; z-index: 20; display: none; }
    /* 按位置分配的下拉菜单向上弹出 */
    #dd-top .dropdown-panel, #dd-jungle .dropdown-panel, #dd-middle .dropdown-panel, #dd-bottom .dropdown-panel, #dd-utility .dropdown-panel { bottom: calc(100% + 4px); top: auto; }
    .dropdown.open .dropdown-panel { display: block; }
    .dropdown-search { width: 100%; padding: 8px 10px; background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.18); border-radius: 6px; outline: none; margin-bottom: 6px; font-size: 12px; }
    /* 搜索框删除按钮样式 */
    .dropdown-search::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; height: 14px; width: 14px; cursor: pointer; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>') no-repeat center; background-size: 12px 12px; }
    .dropdown-search::-webkit-search-cancel-button:hover { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'); }
    .dropdown-list { max-height: 200px; overflow: auto; border-radius: 6px; }
    /* 下拉菜单滚动条样式 */
    .dropdown-list::-webkit-scrollbar { width: 6px; }
    .dropdown-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
    .dropdown-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    .dropdown-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    .dropdown-item { padding: 6px 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-radius: 4px; font-size: 12px; }
    .dropdown-item:hover { background: rgba(255,255,255,0.08); }
    .dropdown-item .name { color: #e7e9ee; }
    .dropdown-empty { padding: 6px 8px; opacity: .7; text-align: center; font-size: 12px; }

    /* 加载状态 */
    .loading { opacity: 0.6; pointer-events: none; }
    .loading::after { content: "加载中..."; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 4px; font-size: 12px; }

    /* 响应式设计 */
    @media (max-width: 365px) {
      main { padding: 12px; }
      .row { grid-template-columns: 1fr; gap: 6px; text-align: center; }
      .dropdown { width: 100%; }
      .switch { justify-self: center; }
      .header-inner { padding: 0 12px; }
    }
  </style>
<style>
      /* 自定义弹窗样式 */
      .custom-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
      }
      
      .custom-alert-box {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #242830;
          border: 1px solid #30363d;
          border-radius: 8px;
          padding: 20px;
          width: 252px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
          text-align: center;
        }
       
       .custom-alert-message {
         margin-bottom: 15px;
         font-size: 14px;
         color: #c9d1d9;
         word-wrap: break-word;
         word-break: break-all;
         line-height: 1.4;
       }
      
      .custom-alert-button {
        padding: 8px 20px;
        background: rgb(106, 167, 188);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .custom-alert-button:hover {
        background: rgb(86, 147, 168);
      }
    </style>
  </head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-left">
        <h1><img src="https://img.dayun.cool/_dayun/AutoBP.webp" alt="AutoBP" style="height: 52px; vertical-align: middle;"></h1>
        <div class="status">
          <span class="badge" id="lcu-status">LCU 未连接</span>
          <span class="badge" id="client-status">客户端状态未知</span>
          <div class="refresh-btn" id="refresh-lcu" title="重新连接LCU">
            ↻
          </div>
        </div>
      </div>
      <div class="header-controls">
        <div class="header-button" onclick="window.runtime.WindowMinimise()">
          <svg class="header-icon" viewBox="0 0 12 12">
            <rect x="0" y="4.5" width="10" height="2"/>
          </svg>
        </div>
        <div class="header-button close" onclick="window.runtime.Quit()">
          <svg class="header-icon" viewBox="0 0 12 12">
            <path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
      </div>
    </div>
  </header>
  <main>
    <!-- 英雄选择设置 -->
    <section>
      <!-- 秒接对局：标题 | 空白 | 开关 -->
      <div class="row">
        <div>
          <strong>秒接对局</strong>
        </div>
        <div></div>
        <div class="switch" id="sw-auto-accept"><div class="knob"></div></div>
      </div>

      <!-- 预选英雄：标题 | 下拉 | 开关 -->
      <div class="row">
        <div>
          <strong>预选英雄</strong>
        </div>
        <div class="dropdown" id="dd-preselect">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div class="switch" id="sw-preselect"><div class="knob"></div></div>
      </div>

      <!-- 秒禁英雄：标题 | 下拉 | 开关 -->
      <div class="row">
        <div>
          <strong>秒禁英雄</strong>
        </div>
        <div class="dropdown" id="dd-ban">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div class="switch" id="sw-ban"><div class="knob"></div></div>
      </div>

      <!-- 秒选英雄：标题 | 下拉 | 开关 -->
      <div class="row">
        <div>
          <strong>秒选英雄</strong>
        </div>
        <div class="dropdown" id="dd-pick">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div class="switch" id="sw-pick"><div class="knob"></div></div>
      </div>
    </section>

    <!-- 按位置选择英雄 -->
    <section>
      <div class="section-title">排位优先使用下面的英雄配置，其他模式使用上面的配置</div>
      <!-- 上路 -->
      <div class="row">
        <div>
          <strong>上路</strong>
        </div>
        <div class="dropdown" id="dd-top">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div></div>
      </div>

      <!-- 打野 -->
      <div class="row">
        <div>
          <strong>打野</strong>
        </div>
        <div class="dropdown" id="dd-jungle">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div></div>
      </div>

      <!-- 中路 -->
      <div class="row">
        <div>
          <strong>中路</strong>
        </div>
        <div class="dropdown" id="dd-middle">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div></div>
      </div>

      <!-- 下路 -->
      <div class="row">
        <div>
          <strong>下路</strong>
        </div>
        <div class="dropdown" id="dd-bottom">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div></div>
      </div>

      <!-- 辅助 -->
      <div class="row">
        <div>
          <strong>辅助</strong>
        </div>
        <div class="dropdown" id="dd-utility">
          <div class="dropdown-trigger"><span class="label">未选择</span><span class="arrow">▾</span></div>
          <div class="dropdown-panel">
            <input type="search" class="dropdown-search" placeholder="搜索英雄..." />
            <div class="dropdown-list">
              <div class="dropdown-item" data-id=""><span class="name">未选择</span></div>
            </div>
          </div>
        </div>
        <div></div>
      </div>
    </section>

    <!-- 功能按钮 -->
    <div style="text-align: left; margin-top: 10px;">
      <button style="padding: 6px 12px; background: rgb(106, 167, 188); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 10px; width: 80px;" id="btn-go-main" onclick="goToMainMenu()">回主界面</button>
      <button style="padding: 6px 12px; background: rgb(106, 167, 188); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 10px; width: 80px;" id="btn-start-ranked" onclick="startRankedQueue()">开单双排</button>
      <button style="padding: 6px 12px; background: rgb(128, 128, 128); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; width: 80px;" onclick="showCustomAlert('敬请期待')">更多功能</button>
    </div>
  </main>
    
    <!-- 自定义弹窗 -->
    <div id="custom-alert-overlay" class="custom-alert-overlay" onclick="closeCustomAlert()">
      <div class="custom-alert-box" onclick="event.stopPropagation()">
        <div id="custom-alert-message" class="custom-alert-message"></div>
        <button class="custom-alert-button" onclick="closeCustomAlert()">确定</button>
      </div>
    </div>



  <script type="module" src="./wailsjs/runtime/runtime.js"></script>
  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    // 全局状态
    let champions = [];
    let config = {};
    let statusUpdateInterval = null;

    // 工具函数
    function setSwitch(el, on) {
      el.classList.toggle('on', !!on);
    }

    function bindSwitch(el, configKey) {
      el.addEventListener('click', async () => {
        const isOn = el.classList.contains('on');
        const newValue = !isOn;
        setSwitch(el, newValue);
        
        // 更新配置
        config[configKey] = newValue;
        await saveConfig();
      });
    }

    // API 调用函数 - 使用Wails运行时
    async function fetchChampions() {
      try {
        const data = await window.go.main.App.GetChampions();
        champions = data || [];
        updateChampionDropdowns();
      } catch (error) {
        console.error('Failed to fetch champions:', error);
      }
    }

    async function fetchConfig() {
      try {
        const data = await window.go.main.App.GetConfig();
        config = data || {};
        updateUIFromConfig();
      } catch (error) {
        console.error('Failed to fetch config:', error);
      }
    }

    async function saveConfig() {
      try {
        await window.go.main.App.SaveConfig(config);
      } catch (error) {
        console.error('Failed to save config:', error);
      }
    }

    async function fetchStatus() {
      try {
        const status = await window.go.main.App.GetStatus();
        updateStatusBadges(status);
      } catch (error) {
        console.error('Failed to fetch status:', error);
        updateStatusBadges({ connected: false, client_status: 'unknown' });
      }
    }

    // 自定义弹窗函数
     function showCustomAlert(message) {
       const overlay = document.getElementById('custom-alert-overlay');
       const messageElement = document.getElementById('custom-alert-message');
       messageElement.textContent = message;
       overlay.style.display = 'block';
     }
     
     function closeCustomAlert() {
       const overlay = document.getElementById('custom-alert-overlay');
       overlay.style.display = 'none';
     }
     
     async function startRankedQueue() {
      try {
        const button = document.getElementById('btn-start-ranked');
        button.disabled = true;
        button.textContent = '创建中...';
        
        await window.go.main.App.StartRankedQueue();
        console.log('成功创建排位赛队列');
        
        // 重置按钮状态
        setTimeout(() => {
          button.disabled = false;
          button.textContent = '开单双排';
        }, 2000);
      } catch (error) {
        console.error('创建排位赛队列失败:', error);
        showCustomAlert('创建失败，请检查客户端状态');
        
        // 重置按钮状态
        const button = document.getElementById('btn-start-ranked');
        button.disabled = false;
        button.textContent = '开单双排';
      }
    }

    async function goToMainMenu() {
      try {
        const button = document.getElementById('btn-go-main');
        button.disabled = true;
        button.textContent = '返回中...';
        
        await window.go.main.App.GoToMainMenu();
        console.log('成功回到主界面');
        
        // 重置按钮状态
        setTimeout(() => {
          button.disabled = false;
          button.textContent = '回主界面';
        }, 1000);
      } catch (error) {
         console.error('回到主界面失败:', error);
         showCustomAlert('回到主界面失败，请检查客户端状态');
        
        // 重置按钮状态
        const button = document.getElementById('btn-go-main');
        button.disabled = false;
        button.textContent = '回主界面';
      }
    }



    // UI 更新函数
    function updateUIFromConfig() {
      // 更新开关状态
      setSwitch($('#sw-preselect'), config.preselect_enabled);
      setSwitch($('#sw-ban'), config.auto_ban_enabled);
      setSwitch($('#sw-pick'), config.auto_pick_enabled);
      setSwitch($('#sw-auto-accept'), config.auto_accept_enabled);

      // 更新下拉选择
      updateDropdownSelection('dd-preselect', config.preselect_champion_id);
      updateDropdownSelection('dd-ban', config.auto_ban_champion_id);
      updateDropdownSelection('dd-pick', config.auto_pick_champion_id);
      
      // 更新位置英雄选择
      if (config.position_champions) {
        updateDropdownSelection('dd-top', config.position_champions.TOP);
        updateDropdownSelection('dd-jungle', config.position_champions.JUNGLE);
        updateDropdownSelection('dd-middle', config.position_champions.MIDDLE);
        updateDropdownSelection('dd-bottom', config.position_champions.BOTTOM);
        updateDropdownSelection('dd-utility', config.position_champions.UTILITY);
      }
    }

    function updateDropdownSelection(dropdownId, championId) {
      const dropdown = $(`#${dropdownId}`);
      const label = dropdown.querySelector('.label');
      
      if (!championId) {
        label.textContent = '未选择';
        return;
      }

      const champion = champions.find(c => c.id === championId);
      if (champion) {
        label.textContent = champion.name;
      } else {
        label.textContent = '未选择';
      }
    }

    function updateChampionDropdowns() {
      const dropdowns = ['dd-preselect', 'dd-ban', 'dd-pick', 'dd-top', 'dd-jungle', 'dd-middle', 'dd-bottom', 'dd-utility'];
      
      dropdowns.forEach(dropdownId => {
        const dropdown = $(`#${dropdownId}`);
        const list = dropdown.querySelector('.dropdown-list');
        
        // 清空现有选项
        list.innerHTML = '<div class="dropdown-item" data-id=""><span class="name">未选择</span></div>';
        
        // 添加英雄选项
        champions.forEach(champion => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.setAttribute('data-id', champion.id);
          item.innerHTML = `<span class="name">${champion.name}</span>`;
          list.appendChild(item);
        });
      });
    }

    function updateStatusBadges(status) {
      const lcuBadge = $('#lcu-status');
      const clientBadge = $('#client-status');
      
      // 更新LCU连接状态
      if (status.connected) {
        lcuBadge.textContent = 'LCU 已连接';
        lcuBadge.className = 'badge connected';
      } else {
        lcuBadge.textContent = 'LCU 未连接';
        lcuBadge.className = 'badge';
      }
      
      // 更新客户端状态
      const statusMap = {
        'Lobby': '房间中',
        'Matchmaking': '匹配中',
        'ReadyCheck': '准备检查',
        'ChampSelect': '英雄选择',
        'GameStart': '游戏开始',
        'InProgress': '游戏中',
        'WaitingForStats': '等待结算',
        'PreEndOfGame': '游戏结束',
        'EndOfGame': '结算页面',
        'None': '主界面',
        'unknown': '未知'
      };
      
      const statusText = statusMap[status.client_status] || status.client_status;
      clientBadge.textContent = `客户端: ${statusText}`;
      
      if (status.client_status === 'ChampSelect') {
        clientBadge.className = 'badge connected';
      } else {
        clientBadge.className = 'badge';
      }
    }

    // 下拉菜单交互
    function createDropdown(el, configKey) {
      const trigger = el.querySelector('.dropdown-trigger');
      const label = trigger.querySelector('.label');
      const panel = el.querySelector('.dropdown-panel');
      const search = el.querySelector('.dropdown-search');
      const list = el.querySelector('.dropdown-list');

      function close() {
        el.classList.remove('open');
      }

      function open() {
        el.classList.add('open');
        search.value = '';
        showAllItems();
        search.focus();
      }

      function showAllItems() {
        const items = list.querySelectorAll('.dropdown-item');
        items.forEach(item => {
          item.style.display = 'flex';
        });
      }

      function filterItems() {
        const term = search.value.trim().toLowerCase();
        const items = list.querySelectorAll('.dropdown-item');
        let hasVisible = false;
        
        items.forEach(item => {
          const name = item.querySelector('.name').textContent.toLowerCase();
          const matches = name.includes(term);
          item.style.display = matches ? 'flex' : 'none';
          if (matches) hasVisible = true;
        });

        // 显示/隐藏"无匹配结果"
        let emptyDiv = list.querySelector('.dropdown-empty');
        if (!hasVisible && term) {
          if (!emptyDiv) {
            emptyDiv = document.createElement('div');
            emptyDiv.className = 'dropdown-empty';
            emptyDiv.textContent = '无匹配结果';
            list.appendChild(emptyDiv);
          }
          emptyDiv.style.display = 'block';
        } else if (emptyDiv) {
          emptyDiv.style.display = 'none';
        }
      }

      // 绑定事件
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        if (el.classList.contains('open')) {
          close();
        } else {
          // 关闭其他下拉菜单
          $$('.dropdown.open').forEach(dd => dd.classList.remove('open'));
          open();
        }
      });

      search.addEventListener('input', filterItems);

      // 选择项目
      list.addEventListener('click', async (e) => {
        const item = e.target.closest('.dropdown-item');
        if (!item) return;
        
        const championId = item.getAttribute('data-id');
        const name = item.querySelector('.name').textContent;
        
        label.textContent = name;
        close();
        
        // 更新配置
        if (configKey.startsWith('position_')) {
          // 处理位置英雄配置
          const position = configKey.replace('position_', '');
          if (!config.position_champions) {
            config.position_champions = {};
          }
          config.position_champions[position] = championId ? parseInt(championId) : null;
        } else {
          // 处理普通配置
          config[configKey] = championId ? parseInt(championId) : null;
        }
        await saveConfig();
      });

      // 点击外部关闭
      document.addEventListener('click', (e) => {
        if (!el.contains(e.target)) {
          close();
        }
      });
    }

    // 初始化函数
    async function init() {
      // 绑定开关
      bindSwitch($('#sw-preselect'), 'preselect_enabled');
      bindSwitch($('#sw-ban'), 'auto_ban_enabled');
      bindSwitch($('#sw-pick'), 'auto_pick_enabled');
      bindSwitch($('#sw-auto-accept'), 'auto_accept_enabled');

      // 初始化下拉菜单
      createDropdown($('#dd-preselect'), 'preselect_champion_id');
      createDropdown($('#dd-ban'), 'auto_ban_champion_id');
      createDropdown($('#dd-pick'), 'auto_pick_champion_id');
      
      // 初始化位置英雄下拉菜单
      createDropdown($('#dd-top'), 'position_TOP');
      createDropdown($('#dd-jungle'), 'position_JUNGLE');
      createDropdown($('#dd-middle'), 'position_MIDDLE');
      createDropdown($('#dd-bottom'), 'position_BOTTOM');
      createDropdown($('#dd-utility'), 'position_UTILITY');

      // 加载数据
      await fetchChampions();
      await fetchConfig();
      
      // 3秒后再次获取配置和英雄数据
      setTimeout(async () => {
        await fetchChampions();
        await fetchConfig();
      }, 3000);
      
      // 绑定刷新按钮事件
      $('#refresh-lcu').addEventListener('click', async () => {
        try {
          await window.go.main.App.ReconnectLCU();
          // 立即更新状态
          setTimeout(() => {
            fetchStatus();
          }, 1000);
        } catch (error) {
          console.error('Failed to reconnect LCU:', error);
        }
      });
      
      // 开始状态轮询（仅轮询状态）
      fetchStatus();
      statusUpdateInterval = setInterval(() => {
        fetchStatus();
      }, 2000);
    }

    // 页面卸载时清理
    window.addEventListener('beforeunload', () => {
      if (statusUpdateInterval) {
        clearInterval(statusUpdateInterval);
      }
    });

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script type="module" src="./wailsjs/runtime/runtime.js"></script>
</body>
</html>
